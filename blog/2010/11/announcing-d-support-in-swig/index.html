<!doctype html> <html lang=en> <head> <meta charset=utf-8> <link rel=stylesheet href='/css/250adbc.css'> <title>Announcing: D support in SWIG | David Nadlinger</title> <meta name=viewport content="width=device-width; initial-scale=1.0"> <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script> <link rel="openid.server" href="http://openid.klickverbot.at/"/> <link rel="openid2.provider" href="http://openid.klickverbot.at/"/> </head> <body> <header id=main_header> <h1><span><a href="/">David Nadlinger</a></span></h1> <nav role=navigation> <ul> <li><a href="/blog">Blog</a></li> <li><a href="/code">Code</a></li> <li><a href="/about">About</a></li> </ul> </nav> </header> <div role=main id=main_content> <article class=blog-post> <header> <h1><a href="/blog/2010/11/announcing-d-support-in-swig/">Announcing: D support in SWIG</a></h1> <section class=metadata> on <time datetime="2010-11-21T00:00:00+00:00">21 Nov 2010</time> </section> <ul class=pagenav> <li><a href="/blog/2010/06/oh-how-glad-i-am-that-actionscript-2-is-dead-and-buried/">Older</a></li> <li><a href="/blog/2010/12/swig-d-breaking-name-changes/">Newer</a></li> </ul> </header> <div class=content> <p>In a nutshell, <a href="http://swig.org"><span class=caps>SWIG</span></a> is a »glue code« generator, allowing you to access C/C++ libraries from various target languages, including C#, Go, Java, Ruby, Python … and, since I merged my work into <span class=caps>SWIG</span> trunk a few days ago, also the <a href="http://digitalmars.com/d/">D programming language</a>, both version 1 and 2.</p> <p>Why would D support in <span class=caps>SWIG</span> be useful in the first place? After all, D is perfectly able to <a href="http://www.digitalmars.com/d/1.0/interfaceToC.html">interface with C</a> on its own, so why bother using a third-party tool?</p> <p>Well, it turns out that even for »plain old C«, there are reasons why you&#8217;d want to use a bindings generator. Besides the obvious problem that you have to convert the C header files to D modules somehow, there is one major inconvenience with directly using C libraries from D: D code usually is on a higher abstraction level than C, and many of the features that make D interesting are simply not available when dealing with C libraries. For instance, you would have to manually convert strings between pointers to <code>\0</code>-terminated char arrays and D <code>string</code>s, and most interesting algorithms from the D2 standard library are simply unusable with C arrays.</p> <p>While these issues can be worked around relatively easy by hand-coding a thin wrapper layer around the C library in question, there is another issue where writing wrapper code per hand is not feasible: C++ class libraries. D1 does not support interfacing with C++ at all, and even if <code>extern(C++)</code> has been added to D2, the support is quite limited, and a custom wrapper layer is still required in many cases.</p> <p>Here is, without further ado, a small example of what the D module for <span class=caps>SWIG</span> allows you to do. Consider the following (admittedly not very useful) piece of C++ code:</p> <figure class=code> <div class=highlight><pre><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;</span> <span class="n">Position</span><span class="p">;</span><br />
<br />
<span class="k">class</span> <span class="nc">Shape</span> <span class="p">{</span><br />
<span class="k">public</span><span class="o">:</span><br />
   <span class="n">Shape</span><span class="p">(</span> <span class="n">Position</span> <span class="n">pos</span> <span class="p">)</span> <span class="o">:</span> <span class="n">m_position</span><span class="p">(</span> <span class="n">pos</span> <span class="p">)</span> <span class="p">{}</span><br />
   <span class="k">virtual</span> <span class="o">~</span><span class="n">Shape</span><span class="p">()</span> <span class="p">{}</span><br />
<br />
   <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getDescription</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><br />
<br />
   <span class="n">Position</span> <span class="n">getPosition</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><br />
      <span class="k">return</span> <span class="n">m_position</span><span class="p">;</span><br />
   <span class="p">}</span><br />
<br />
<span class="k">protected</span><span class="o">:</span><br />
   <span class="n">Position</span> <span class="n">m_position</span><span class="p">;</span><br />
<span class="p">};</span><br />
<br />
<span class="k">class</span> <span class="nc">Circle</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Shape</span> <span class="p">{</span><br />
<span class="k">public</span><span class="o">:</span><br />
   <span class="n">Circle</span><span class="p">(</span> <span class="n">Position</span> <span class="n">pos</span> <span class="p">)</span> <span class="o">:</span> <span class="n">Shape</span><span class="p">(</span> <span class="n">pos</span> <span class="p">)</span> <span class="p">{}</span><br />
   <span class="k">virtual</span> <span class="o">~</span><span class="n">Circle</span><span class="p">()</span> <span class="p">{}</span><br />
<br />
   <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getDescription</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><br />
      <span class="k">return</span> <span class="s">&quot;A perfect circle.&quot;</span><span class="p">;</span><br />
   <span class="p">}</span><br />
<span class="p">};</span><br />
<br />
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">toString</span><span class="p">(</span> <span class="k">const</span> <span class="n">Shape</span><span class="o">&amp;</span> <span class="n">shape</span> <span class="p">)</span> <span class="p">{</span><br />
   <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">result</span><span class="p">;</span><br />
<br />
   <span class="n">Position</span> <span class="n">p</span> <span class="o">=</span> <span class="n">shape</span><span class="p">.</span><span class="n">getPosition</span><span class="p">();</span><br />
   <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A shape at (&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">.</span><span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">.</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;).&quot;</span><span class="p">;</span><br />
   <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; It looks like this: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">shape</span><span class="p">.</span><span class="n">getDescription</span><span class="p">();</span><br />
<br />
   <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="n">str</span><span class="p">();</span><br />
<span class="p">}</span><br />
</pre></div></figure> <p>By using <span class=caps>SWIG</span> to generate the necessary glue code, you can easily make the classes available in D, as demonstrated by the following small program:</p> <figure class=code> <div class=highlight><pre><span class="k">class</span> <span class="n">Square</span> <span class="p">:</span> <span class="n">Shape</span> <span class="p">{</span><br />
   <span class="k">this</span><span class="p">(</span> <span class="n">Position</span> <span class="n">pos</span> <span class="p">)</span> <span class="p">{</span><br />
      <span class="k">super</span><span class="p">(</span> <span class="n">pos</span> <span class="p">);</span><br />
   <span class="p">}</span><br />
<br />
   <span class="k">override</span> <span class="nb">string</span> <span class="n">getDescription</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><br />
      <span class="k">return</span> <span class="s">&quot;Quite square-ish.&quot;</span><span class="p">;</span><br />
   <span class="p">}</span><br />
<span class="p">}</span><br />
<br />
<span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span><br />
   <span class="c1">// One of the ugliest bugs currently in D: Type inference does not</span><br />
   <span class="c1">// work correctly for arrays of classes with a common supertype.</span><br />
   <span class="k">auto</span> <span class="n">shapes</span> <span class="p">=</span> <span class="p">[</span><br />
      <span class="k">cast</span><span class="p">(</span> <span class="n">Shape</span> <span class="p">)</span> <span class="k">new</span> <span class="n">Circle</span><span class="p">(</span> <span class="k">new</span> <span class="n">Position</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">),</span><br />
      <span class="k">new</span> <span class="n">Square</span><span class="p">(</span> <span class="k">new</span> <span class="n">Position</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span><br />
   <span class="p">];</span><br />
<br />
   <span class="k">foreach</span> <span class="p">(</span> <span class="n">shape</span><span class="p">;</span> <span class="n">shapes</span> <span class="p">)</span> <span class="p">{</span><br />
      <span class="n">writeln</span><span class="p">(</span> <span class="n">toString</span><span class="p">(</span> <span class="n">shape</span> <span class="p">)</span> <span class="p">);</span><br />
   <span class="p">}</span><br />
<span class="p">}</span><br />
</pre></div></figure> <figure><pre><code>A shape at (1, 3). It looks like this: A perfect circle.
A shape at (2, 1). It looks like this: Quite square-ish.</code></pre></figure> <p>Note that <code>Shape</code> is extended on the D side just as usual and how the C++ call to <code>getDescription()</code> is transparently routed to <code>Square.getDescription()</code>. This mechanism dubbed <em>cross language polymorphism</em> is enabled by a feature of <span class=caps>SWIG</span> called »directors«, which causes the extra indirection layer needed for this to be emitted. Also note how the strings are seamlessly converted between their C++ and D representation.</p> <p>So you want to give the D module in <span class=caps>SWIG</span> a whirl? Just head over to the <a href="https://swig.svn.sourceforge.net/svnroot/swig/trunk/"><span class=caps>SWIG</span> <span class=caps>SVN</span></a>, grab the sources from there, and <a href="http://swig.org/svn.html">build it</a>. If you are planning to run the test suite or the included examples, you might want to specify <code>--with-d1-compiler=&lt;…&gt;</code> and <code>--with-d2-compiler=&lt;…&gt;</code> at the <code>configure</code> command line. In case you want to play around with the small example from above, I also put up a <a href="demo.zip">small archive</a> containing the files (for such a small example, the C++ code could be included directly in the <span class=caps>SWIG</span> interface file via the <code>%inline</code> directive, but that&#8217;s how you would probably want to tackle a real library).</p> <p>What can you expect to work? The test-suite which covers all the basic features of <span class=caps>SWIG</span> should build and run fine, which means that it will probably just work when trying to wrap a library. The source tree includes also a documentation chapter on D (<code>Doc/Manual/D.html</code>) which describes the basic structure and some of the D-specific features. As the D module started out as a fork from the C# one, the documentation on C# could be of considerable use for you as well.</p> <p>There are still a few areas which need serious work, though. One of them is <em>operator overloading</em>, where both semantics and implementation differ quite a lot between C++ and D. It would probably be not too hard to come up with a solution (maybe using D&#8217;s extensive compile-time reflection capabilities to avoid having to add special cases to the <span class=caps>SWIG</span> module), but I would really appreciate some help from someone actually needing it here.</p> <p>The other big one is <em>multithreading support</em>. Since I personally have not needed to use C++ libraries from D in a threaded setting yet, I have not really thought about the problems arising from multiple threads calling the wrapper code. Especially in combination with the garbage collector, I expect quite a lot of issues to pop up in a serious multithreaded environment. There are a few places which include threading-related code (<code>synchronized</code>, <code>shared</code>, …), but these are mostly remnants from the C# module, which may or may not apply to D – once again, I would be happy if somebody needing this would help me out here.</p> <p>Speaking of C# remnants: As mentioned above, the D module was forked from the C# module, which in turn started out as a fork from the Java one. Due to this heritage, there are a few places where things could be done much easier in D. For example, the code for <em>returning C strings to D</em> without memory leaks is unnecessarily complex at the moment. But the same applies here as well – I would be happy to support anyone wanting to clean this up, but the current implementation did its job for me so far.</p> <p>Anyway, I would be glad if some of you could go ahead and put <span class=caps>SWIG</span> to real-world use, so that any major bug can be fixed before the next <span class=caps>SWIG</span> release (not planned so far). If you stumble upon any issues or if any questions should arise, please feel free to contact me, either via <a href="/about#contact">mail</a>, on <a href="http://www.digitalmars.com/webnews/newsgroups.php?group=digitalmars.D">digitalmars.D</a> or in <a href="irc://irc.freenode.net/D">#D on freenode</a>. Besides that, as always, it would also be nice just to hear about what you are doing with this.</p> <p class=update>In the meantime, two severe bugs in the code generated for Windows have been fixed; please be sure to use the latest version from <span class=caps>SVN</span>.</p> <footer> Like what you read? <a href="http://twitter.com/?status=@dnadlinger:">Let me know</a> what you think or <a href="http://twitter.com/?status=Just read »Announcing: D support in SWIG« by @dnadlinger: http://klickverbot.at/blog/2010/11/announcing-d-support-in-swig/">share the article</a> on Twitter. Also, there is more on <a href="/blog/tags/D/" title="View all posts tagged with »D«" rel=tag>D</a> and <a href="/blog/tags/SWIG/" title="View all posts tagged with »SWIG«" rel=tag>SWIG</a>. </footer> </div> </article> </div> <footer id=main_footer> <ul> <li><a class=twitter href="//twitter.com/dnadlinger">Follow me on Twitter</a></li> <li><a class=mail href="/about">Contact me</a></li> <li><a class=rss href="/blog/atom.xml">Blog feed</a></li> </ul> </footer> </body> </html>