<!doctype html> <html lang=en> <head> <meta charset=utf-8> <link rel=stylesheet href='/css/250adbc.css'> <title>D/Thrift GSoC: First results | David Nadlinger</title> <meta name=viewport content="width=device-width; initial-scale=1.0"> <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script> <link rel="openid.server" href="http://openid.klickverbot.at/"/> <link rel="openid2.provider" href="http://openid.klickverbot.at/"/> </head> <body> <header id=main_header> <h1><span><a href="/">David Nadlinger</a></span></h1> <nav role=navigation> <ul> <li><a href="/blog">Blog</a></li> <li><a href="/code">Code</a></li> <li><a href="/about">About</a></li> </ul> </nav> </header> <div role=main id=main_content> <article class=blog-post> <header> <h1><a href="/blog/2011/05/d-thrift-gsoc-first-results/">D/Thrift GSoC: First results</a></h1> <section class=metadata> on <time datetime="2011-05-29T00:00:00+01:00">29 May 2011</time> </section> <ul class=pagenav> <li><a href="/blog/2011/04/random-d-development-news/">Older</a></li> <li><a href="/blog/2011/06/d-thrift-gsoc-growing-the-library/">Newer</a></li> </ul> </header> <div class=content> <p>The first week of my <a href="/code/gsoc/thrift/"><em>D/Thrift</em> project</a> as part of the <a href="http://d-programming-language.org">D programming language</a> <a href="http://www.google-melange.com/gsoc/org/google/gsoc2011/dprogramminglanguage">Google Summer of Code 2011</a> is over, and I am happy to be able to share some first results. If you are not sure what I am talking about yet: <a href="http://thrift.apache.org">Apache Thrift</a>, originally developed for internal use at <a href="http://facebook.com">Facebook</a>, is both a data serialization/RPC protocol and its reference implementation. In short, it works by defining data types and services interface in a language-agnostic interface definition file. Then, a compiler is used for generating code from that <code>.thrift</code> file (currently written in C++), using target language support libraries which contain the actual serialization protocol/RPC implementation. Currently, Thrift supports a large number of languages including C++, Java, PHP and Python.</p> <p>It was clear from the beginning that I would stick with this approach for my implementation, not only because the informal project goal is to establish D as an equal target language besides the existing ones, but simply because one of the main strengths of Thrift is that you can use the same interface definition for all target languages, with the compiler doing all the heavy lifting for you. I did, however, want to leverage the powerful metaprogramming capabilities of D (compile-time reflection, <abbr title="Compile Time Function Execution">CTFE</abbr>, string mixins) to lift as much work off the »ahead-of-time« C++ code generator as possible, having the option to use the Thrift libraries beyond the traditional scope of the project for ad-hoc extension of existing D data types and interfaces with serialization/RPC functionality at the back of my mind.</p> <p>My primary goal during the first week was to evaluate the feasibility of this approach by quickly implementing the basic parts of each Thrift component. In more detail, the sub-goals I tackled during the last week were:</p> <ul> <li> <p>Create a preliminary implementation the central parts of the support library (<code>TBinaryProtocol</code>, <code>TBufferedTransport</code>, <code>TSocket</code>, …) using the C++ and Java implementations as reference to be able to directly test the progressing D implementation against other languages.</p> </li> <li> <p>Implement the general and client-specific parts of compile-time code generation (struct reading/writing, method arguments/result struct generation <code>TClient</code>, …), using a hand-crafted Thrift tutorial interface to test it against the Java server.</p> </li> <li> <p>Implement <code>TSimpleServer</code> and related basic server functionality (e.g. <code>TServerSocket</code>) to be able to test server code generation.</p> </li> <li> <p>Complete missing server-side code generation bits (<code>TProcessor</code>, server-side arguments/result structs, …), again using a hand-crafted interface to test it against the Java Thrift calculator tutorial client.</p> </li> <li> <p>Add D code generation to the Thrift compiler, and run the compiler against all the test interface files coming with Thrift (<code>test/*.thrift</code>) to catch any obvious issues.</p> </li> <li> <p>Implement a <code>ThriftTest</code> server and client in D to exercise the more advanced serialization code paths and fix any bugs, testing it against the C++ implementation.</p> </li> </ul> <p>So far, no major problems popped up, and I was able to complete the above list as planned. I did, however, hit a few bugs in DMD, which is, on the other hand, doesn’t come as a total surprise because I am heavily using the metaprogramming facilities. I have been able to find workarounds for all of the issues, but it nevertheless took me quite some time to track them down initially: issues <a href="http://d.puremagic.com/issues/show_bug.cgi?id=6069">6069</a>, <a href="http://d.puremagic.com/issues/show_bug.cgi?id=6077">6077</a>, <a href="http://d.puremagic.com/issues/show_bug.cgi?id=6078">6078</a>, <a href="https://github.com/D-Programming-Language/dmd/pull/77">DMD pull request 77</a> and – this one is merely an enhancement – <a href="https://github.com/D-Programming-Language/phobos/pull/65">Phobos pull request 65</a>.</p> <p>If you want to have a look at the code, feel free to head to <a href="https://github.com/dnadlinger/thrift/tree/d-gsoc">my GitHub Thrift fork</a>, where I regularly push my work to. And just to give you a short glimpse of the very basic features (a lot more is already implemented), this is how you could implement a simple calculator server/client which adds two numbers using the Thrift library, without using any generated code.</p> <figure class=code> <div class=highlight><pre><span class="c1">// This could also be generated from a .thrift file and contain</span>
<span class="c1">// structs, exceptions, etc.</span>
<span class="k">module</span> <span class="n">calculator</span><span class="p">;</span>

<span class="k">interface</span> <span class="n">Calculator</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">lhs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rhs</span><span class="p">);</span>
<span class="p">}</span>
</pre></div><figcaption><span>Shared module containing the interface the server offers and the client consumes. </span></figcaption> </figure> <figure class=code> <div class=highlight><pre><span class="k">module</span> <span class="n">server</span><span class="p">;</span>

<span class="k">import</span> <span class="n">calculator</span><span class="p">;</span>
<span class="k">import</span> <span class="n">thrift</span><span class="p">.</span><span class="n">codegen</span><span class="p">.</span><span class="n">processor</span><span class="p">;</span>
<span class="k">import</span> <span class="n">thrift</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">binary</span><span class="p">;</span>
<span class="k">import</span> <span class="n">thrift</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">processor</span><span class="p">;</span>
<span class="k">import</span> <span class="n">thrift</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="n">simple</span><span class="p">;</span>
<span class="k">import</span> <span class="n">thrift</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">buffered</span><span class="p">;</span>
<span class="k">import</span> <span class="n">thrift</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">serversocket</span><span class="p">;</span>

<span class="k">class</span> <span class="n">CalculatorHandler</span> <span class="p">:</span> <span class="n">Calculator</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kt">int</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">lhs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">n1</span> <span class="p">+</span> <span class="n">n2</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Expose a CalculatorHandler instance at port 9090.</span>
  <span class="k">auto</span> <span class="n">protocolFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TBinaryProtocolFactory</span><span class="p">();</span>
  <span class="k">auto</span> <span class="n">processor</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TServiceProcessor</span><span class="p">!</span><span class="n">Calculator</span><span class="p">(</span>
    <span class="k">new</span> <span class="n">CalculatorHandler</span><span class="p">());</span>
  <span class="k">auto</span> <span class="n">serverTransport</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TServerSocket</span><span class="p">(</span><span class="mi">9090</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">transportFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TBufferedTransportFactory</span><span class="p">();</span>

  <span class="k">auto</span> <span class="n">server</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TSimpleServer</span><span class="p">(</span>
    <span class="n">processor</span><span class="p">,</span> <span class="n">serverTransport</span><span class="p">,</span> <span class="n">transportFactory</span><span class="p">,</span> <span class="n">protocolFactory</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">serve</span><span class="p">();</span>
<span class="p">}</span>
</pre></div><figcaption><span>Server implementation, accepting connections on port 9090 using the binary protocol. </span></figcaption> </figure> <figure class=code> <div class=highlight><pre><span class="k">module</span> <span class="n">client</span><span class="p">;</span>

<span class="k">import</span> <span class="n">calculator</span><span class="p">;</span>
<span class="k">import</span> <span class="n">std</span><span class="p">.</span><span class="n">stdio</span><span class="p">;</span>
<span class="k">import</span> <span class="n">thrift</span><span class="p">.</span><span class="n">codegen</span><span class="p">.</span><span class="n">client</span><span class="p">;</span>
<span class="k">import</span> <span class="n">thrift</span><span class="p">.</span><span class="n">protocol</span><span class="p">.</span><span class="n">binary</span><span class="p">;</span>
<span class="k">import</span> <span class="n">thrift</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">buffered</span><span class="p">;</span>
<span class="k">import</span> <span class="n">thrift</span><span class="p">.</span><span class="n">transport</span><span class="p">.</span><span class="n">socket</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Set up a client for the Calculator interface and try to</span>
  <span class="c1">// connect to localhost:9090.</span>
  <span class="k">auto</span> <span class="n">socket</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TSocket</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">9090</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">transport</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TBufferedTransport</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">protocol</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TBinaryProtocol</span><span class="p">(</span><span class="n">transport</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TClient</span><span class="p">!</span><span class="n">Calculator</span><span class="p">(</span><span class="n">protocol</span><span class="p">);</span>
  <span class="n">transport</span><span class="p">.</span><span class="n">open</span><span class="p">();</span>

  <span class="c1">// Call the server&#39;s add() method and print the result.</span>
  <span class="k">auto</span> <span class="n">lhs</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">rhs</span> <span class="p">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">sum</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">);</span>
  <span class="n">writefln</span><span class="p">(</span><span class="s">&quot;%s + %s = %s&quot;</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>
<span class="p">}</span>
</pre></div><figcaption><span>Client implementation. Note how the interface defined above in the <code>calculator</code> module is passed to TClient as a template parameter, which then generates the necessary RPC code. </span></figcaption> </figure> <footer> Like what you read? <a href="http://twitter.com/?status=@dnadlinger:">Let me know</a> what you think or <a href="http://twitter.com/?status=Just read »D/Thrift GSoC: First results« by @dnadlinger: http://klickverbot.at/blog/2011/05/d-thrift-gsoc-first-results/">share the article</a> on Twitter. Also, there is more on <a href="/blog/tags/D/" title="View all posts tagged with »D«" rel=tag>D</a>, <a href="/blog/tags/GSoC/" title="View all posts tagged with »GSoC«" rel=tag>GSoC</a> and <a href="/blog/tags/Thrift/" title="View all posts tagged with »Thrift«" rel=tag>Thrift</a>. </footer> </div> </article> </div> <footer id=main_footer> <ul> <li><a class=twitter href="//twitter.com/dnadlinger">Follow me on Twitter</a></li> <li><a class=mail href="/about">Contact me</a></li> <li><a class=rss href="/blog/atom.xml">Blog feed</a></li> </ul> </footer> </body> </html>