<!doctype html> <html lang=en> <head> <meta charset=utf-8> <link rel=stylesheet href='/css/250adbc.css'> <title>getaddrinfo cross-platform edge case behavior | David Nadlinger</title> <meta name=viewport content="width=device-width; initial-scale=1.0"> <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script> <link rel="openid.server" href="http://openid.klickverbot.at/"/> <link rel="openid2.provider" href="http://openid.klickverbot.at/"/> </head> <body> <header id=main_header> <h1><span><a href="/">David Nadlinger</a></span></h1> <nav role=navigation> <ul> <li><a href="/blog">Blog</a></li> <li><a href="/code">Code</a></li> <li><a href="/about">About</a></li> </ul> </nav> </header> <div role=main id=main_content> <article class=blog-post> <header> <h1><a href="/blog/2012/01/getaddrinfo-edge-case-behavior-on-windows-linux-and-osx/"><code>getaddrinfo</code> cross-platform edge case behavior</a></h1> <section class=metadata> on <time datetime="2012-01-31T00:00:00+00:00">31 Jan 2012</time> </section> <ul class=pagenav> <li><a href="/blog/2011/08/d-thrift-gsoc-performance-and-other-random-things/">Older</a></li> <li><a href="/blog/2012/03/thrift-now-officially-supports-d/">Newer</a></li> </ul> </header> <div class=content> <p>An often-needed piece of functionality in network programming is to resolve human-readable host or port names to their numerical equivalent, for example in order to pass the latter to operating system socket APIs. The <code>getaddrinfo</code> function fills this role on POSIX and Windows. Apart from some flags, it accepts two string parameters for host and service (port) names and returns a list of corresponding IP addresses and port numbers, superseding the older <code>gethostbyname</code> and <code>getservbyname</code> functions.</p> <p>Either of its string parameters is allowed to be <code>null</code>, representing the local host/all interfaces (depending on whether <code>AI_PASSIVE</code> is specified) and an automatically assigned port, respectively. Both parameters being <code>null</code> at the same time, however, is disallowed by the specification, and leads to a <code>EAI_NONAME</code> error on Posix or <code>WSAHOST_NOT_FOUND</code> on Windows. What happens if the strings are empty (<code>"\0"</code>) instead of <code>null</code>, however, is left open by RFC 2553, and not really mentioned in the operating system API documentation either.</p> <p>It turns out that there are quite a few differences there between the various operating systems, which is obviously likely to cause issues for <a href="http://winehq.org">Wine</a> (an implementation of the Windows API on Posix/X systems). To get a clear understanding of how the different cases are handled, I put together a little <a href="http://dlang.org">D</a> program which tests a few combinations of host name, port, and flag parameters (see end of post). The snippet could be written in C just the same, as <code>getAddressInfo</code> directly maps to <code>getaddrinfo</code>, I just chose D to avoid platform dependencies and writing an unduly large amount of more boilerplate code.</p> <p>The results are summarized in the following table, where »loopback« means that the IP addresses returned were <code>127.0.0.1</code> and <code>::1</code>, »catchall« refers to <code>0.0.0.0</code> and <code>::</code>, »public« means that the actual IP addresses of all available network interfaces were returned, and <code>NONAME</code> refers to a lookup error. »hostname« means that the actual fully qualified name of the host that ran the test was used (care: the host part of the FQDN only does usually <em>not</em> resolve on OS X).</p> <figure> <table> <thead> <tr> <th>Host</th> <th>Port</th> <th>Flags</th> <th>Windows</th> <th>Linux</th> <th>OS X</th> </tr> </thead> <tbody> <tr class=odd> <td><code>null</code></td> <td><code>null</code></td> <td>-</td> <td><code>NONAME</code></td> <td><code>NONAME</code></td> <td><code>NONAME</code></td> </tr> <tr class=odd> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td><code>NONAME</code></td> <td><code>NONAME</code></td> <td><code>NONAME</code></td> </tr> <tr> <td>&nbsp;</td> <td><code>""</code></td> <td>-</td> <td>loopback</td> <td>loopback</td> <td><code>NONAME</code></td> </tr> <tr> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>catchall</td> <td>catchall</td> <td><code>NONAME</code></td> </tr> <tr class=odd> <td>&nbsp;</td> <td><code>"0"</code></td> <td>-</td> <td>loopback</td> <td>loopback</td> <td>loopback</td> </tr> <tr class=odd> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>catchall</td> <td>catchall</td> <td>catchall</td> </tr> <tr> <td>&nbsp;</td> <td><code>"80"</code></td> <td>-</td> <td>loopback</td> <td>loopback</td> <td>loopback</td> </tr> <tr> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>catchall</td> <td>catchall</td> <td>catchall</td> </tr> <tr class=odd> <td><code>""</code></td> <td><code>null</code></td> <td>-</td> <td>public</td> <td><code>NONAME</code></td> <td><code>NONAME</code></td> </tr> <tr class=odd> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>public</td> <td><code>NONAME</code></td> <td><code>NONAME</code></td> </tr> <tr> <td>&nbsp;</td> <td><code>""</code></td> <td>-</td> <td>public</td> <td><code>NONAME</code></td> <td><code>NONAME</code></td> </tr> <tr> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>public</td> <td><code>NONAME</code></td> <td><code>NONAME</code></td> </tr> <tr class=odd> <td>&nbsp;</td> <td><code>"0"</code></td> <td>-</td> <td>public</td> <td><code>NONAME</code></td> <td>loopback</td> </tr> <tr class=odd> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>public</td> <td><code>NONAME</code></td> <td>catchall</td> </tr> <tr> <td>&nbsp;</td> <td><code>"80"</code></td> <td>-</td> <td>public</td> <td><code>NONAME</code></td> <td>loopback</td> </tr> <tr> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>public</td> <td><code>NONAME</code></td> <td>catchall</td> </tr> <tr class=odd> <td><code>"localhost"</code></td> <td><code>null</code></td> <td>-</td> <td>loopback</td> <td>loopback (v4)</td> <td>loopback</td> </tr> <tr class=odd> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>loopback</td> <td>loopback (v4)</td> <td>loopback</td> </tr> <tr> <td>&nbsp;</td> <td><code>""</code></td> <td>-</td> <td>loopback</td> <td>loopback (v4)</td> <td>loopback</td> </tr> <tr> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>loopback</td> <td>loopback (v4)</td> <td>loopback</td> </tr> <tr class=odd> <td>&nbsp;</td> <td><code>"0"</code></td> <td>-</td> <td>loopback</td> <td>loopback (v4)</td> <td>loopback</td> </tr> <tr class=odd> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>loopback</td> <td>loopback (v4)</td> <td>loopback</td> </tr> <tr> <td>&nbsp;</td> <td><code>"80"</code></td> <td>-</td> <td>loopback</td> <td>loopback (v4)</td> <td>loopback</td> </tr> <tr> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>loopback</td> <td>loopback (v4)</td> <td>loopback</td> </tr> <tr class=odd> <td>hostname</td> <td><code>null</code></td> <td>-</td> <td>public</td> <td>loopback (v4)</td> <td>public</td> </tr> <tr class=odd> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>public</td> <td>loopback (v4)</td> <td>public</td> </tr> <tr> <td>&nbsp;</td> <td><code>""</code></td> <td>-</td> <td>public</td> <td>loopback (v4)</td> <td>public</td> </tr> <tr> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>public</td> <td>loopback (v4)</td> <td>public</td> </tr> <tr class=odd> <td>&nbsp;</td> <td><code>"0"</code></td> <td>-</td> <td>public</td> <td>loopback (v4)</td> <td>public</td> </tr> <tr class=odd> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>public</td> <td>loopback (v4)</td> <td>public</td> </tr> <tr> <td>&nbsp;</td> <td><code>"80"</code></td> <td>-</td> <td>public</td> <td>loopback (v4)</td> <td>public</td> </tr> <tr> <td colspan=2>&nbsp;</td> <td><code>AI_PASSIVE</code></td> <td>public</td> <td>loopback (v4)</td> <td>public</td> </tr> </tbody> </table> <figcaption><code>getaddrinfo()</code> behavior on Windows Server 2008 R2, Arch Linux (Kernel 3.1.4, glibc 2.14.1), and OS X 10.7.2 (Lion).</figcaption> </figure> <p>What caused me to investigate the issue in the first place is the behavior when given an empty, non-null host string: Windows returns the public addresses of the present interfaces, while OS X resolves them to <code>::1</code>/<code>::</code>, but only if a port is given, and Linux doesn’t resolve them at all! Windows generally accepts the most combinations, returning an error only for the explicitly disallowed combination, which is relied on by some applications (e.g. the game <em>League of Legends</em>).</p> <p>There were also some less significant differences in behavior which are mostly not listed in the table. First, in both of the Linux VMs I tried (an up-to-date Arch box and Ubuntu Oneric), only the IPv4 address of the loopback interface was returned. Second, as in the test no address family, socket type or protocol hints were passed to <code>getaddrinfo()</code>, each address was returned twice on OS X, once with <code>SOCK_STREAM</code>/<code>IPPROTO_TCP</code> and once with <code>SOCK_DGRAM</code>/<code>IPPROTO_UDP</code> set. Linux returned three copies of each address, for <code>STREAM</code>, <code>DGRAM</code> and <code>RAW</code>, with the according protocol types set, whereas Windows only returned a single copy with protocol type <code>IPPROTO_IP</code> and socket type set to 0.</p> <p>In any case, as a result I have prepared a patch for Wine to emulate at least the succeeding/failing behavior of the Winsock incarnation of <code>getaddrinfo</code> on Linux and OS X, which should solve the bigger part of the related problems. There ideally shouldn’t be any Windows software relying on details beyond that (such as the actual number/layout of addresses returned), but who knows…</p> <figure class=code> <div class=highlight><pre><span class="k">import</span> <span class="n">std</span><span class="p">.</span><span class="n">algorithm</span><span class="p">,</span> <span class="n">std</span><span class="p">.</span><span class="n">conv</span><span class="p">,</span> <span class="n">std</span><span class="p">.</span><span class="n">range</span><span class="p">,</span> <span class="n">std</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">std</span><span class="p">.</span><span class="n">stdio</span><span class="p">;</span>
<span class="k">alias</span> <span class="n">AIF</span> <span class="p">=</span> <span class="n">AddressInfoFlags</span><span class="p">;</span>
<span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="n">host</span><span class="p">;</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">Socket</span><span class="p">.</span><span class="n">hostName</span><span class="p">()])</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="n">port</span><span class="p">;</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;80&quot;</span><span class="p">])</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="n">flags</span><span class="p">;</span> <span class="p">[</span><span class="k">cast</span><span class="p">(</span><span class="n">AIF</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="n">AIF</span><span class="p">.</span><span class="n">PASSIVE</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">write</span><span class="p">(</span>
      <span class="n">host</span> <span class="p">?</span> <span class="s">&quot;&#39;&quot;</span> <span class="p">~</span> <span class="n">host</span> <span class="p">~</span> <span class="s">&quot;&#39;&quot;</span> <span class="p">:</span> <span class="s">&quot;null&quot;</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">,</span>
      <span class="n">port</span> <span class="p">?</span> <span class="s">&quot;&#39;&quot;</span> <span class="p">~</span> <span class="n">port</span> <span class="p">~</span> <span class="s">&quot;&#39;&quot;</span> <span class="p">:</span> <span class="s">&quot;null&quot;</span><span class="p">,</span> <span class="s">&quot; (&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="s">&quot;): &quot;</span>
    <span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">getAddressInfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="p">.</span><span class="n">sort</span><span class="p">!((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">a</span><span class="p">.</span><span class="n">family</span> <span class="p">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">family</span><span class="p">)</span>
        <span class="p">.</span><span class="n">map</span><span class="p">!(</span><span class="n">a</span> <span class="p">=&gt;</span> <span class="n">text</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="s">&quot; (&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">))</span>
        <span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">writeln</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">writefln</span><span class="p">(</span><span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div><figcaption><span>D program used for gathering the data (longer than necessary for somewhat nicely formatted output). </span></figcaption> </figure> <footer> Like what you read? <a href="http://twitter.com/?status=@dnadlinger:">Let me know</a> what you think or <a href="http://twitter.com/?status=Just read »<code>getaddrinfo</code> cross-platform edge case behavior« by @dnadlinger: http://klickverbot.at/blog/2012/01/getaddrinfo-edge-case-behavior-on-windows-linux-and-osx/">share the article</a> on Twitter. Also, there is more on <a href="/blog/tags/D/" title="View all posts tagged with »D«" rel=tag>D</a>. </footer> </div> </article> </div> <footer id=main_footer> <ul> <li><a class=twitter href="//twitter.com/dnadlinger">Follow me on Twitter</a></li> <li><a class=mail href="/about">Contact me</a></li> <li><a class=rss href="/blog/atom.xml">Blog feed</a></li> </ul> </footer> </body> </html>