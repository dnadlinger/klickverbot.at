<!doctype html> <html lang=en> <head> <meta charset=utf-8> <link rel=stylesheet href='/css/250adbc.css'> <title>The State of LDC on Windows | David Nadlinger</title> <meta name=viewport content="width=device-width; initial-scale=1.0"> <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script> <link rel="openid.server" href="http://openid.klickverbot.at/"/> <link rel="openid2.provider" href="http://openid.klickverbot.at/"/> </head> <body> <header id=main_header> <h1><span><a href="/">David Nadlinger</a></span></h1> <nav role=navigation> <ul> <li><a href="/blog">Blog</a></li> <li><a href="/code">Code</a></li> <li><a href="/about">About</a></li> </ul> </nav> </header> <div role=main id=main_content> <article class=blog-post> <header> <h1><a href="/blog/2013/05/the-state-of-ldc-on-windows/">The State of LDC on Windows</a></h1> <section class=metadata> on <time datetime="2013-05-31T00:00:00+01:00">31 May 2013</time> </section> <ul class=pagenav> <li><a href="/blog/2012/05/purity-in-d/">Older</a></li> <li><a href="/blog/2016/01/testing-verilog-axi4-lite-peripherals/">Newer</a></li> </ul> </header> <div class=content> <p class=lead>LDC is one of the three major D compilers. It uses the same frontend as DMD, the reference implementation of the language, but leverages LLVM for optimization and code generation. While it has been stable on Linux and OS X for quite some time, support for the Windows operating system family was virtually non-existent so far. There have been substantial advances recently, and this post gives an overview of the current situation.</p> <p>Before going on to discuss the present status, though, let me quickly answer the inevitable question: Why did it take so long? It is not that the importance of Windows as a target platform would not have been recognized by the D community (or the LDC contributors in particular). Instead, the reason for the lack on of a working Windows port was caused by the fact that LLVM itself did not support all the required operating system specific features. Notably, exception handling was not implemented at all on Windows for a long time.</p> <p>This applies to 32-bit variants of Windows (<em>Win32</em>) as well as to the newer 64-bit operating systems (<em>Win64</em>), but interestingly the reasons for this are completely different. In the latter case, the problem was just that nobody took the time to implement the (table-driven) Win64 exception handling scheme in the LLVM backend. This is not so surprising, as most of the big companies sponsoring LLVM development are not using LLVM on Windows, or in an application domain that does not require features such as native exception handling or thread-local storage support.</p> <p>However, Kai Nacke has tackled this problem recently, among with a number of other LLVM issues blocking development of the Visual Studio-based Win64 port of LDC. A patch fixing the bulk of the bugs in the exception handling implementation is currently under review on the LLVM development mailing list, and Kai has <a href="http://forum.dlang.org/post/vscpokspiejlckivqsuq@forum.dlang.org">prepared a binary preview version of LDC</a> with all the latest patches. For more information, you can also visit the <a href="http://wiki.dlang.org/Building_and_hacking_LDC_on_Windows_using_MSVC">Building and hacking LDC on Windows using MSVC</a> page on the LDC wiki.</p> <p>The rest of this post will discuss the situation specifically on Win32/MinGW. Here, the root problem is that Structured Exception Handling (<em>SEH</em>), the default exception handling mechanism on 32-bit Windows, is covered by a <a href="http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO1&amp;Sect2=HITOFF&amp;d=PALL&amp;p=1&amp;u=%2Fnetahtml%2FPTO%2Fsrchnum.htm&amp;r=1&amp;f=G&amp;l=50&amp;s1=5,628,016.PN.&amp;OS=PN/5,628,016&amp;RS=PN/5,628,016">Borland-held patent</a>. It will not expire until next year, and while Borland seems to dismiss any related concerns, the GCC and LLVM projects have decided to not include an implementation of SEH in their compiler backends for fear of legal trouble.</p> <p>Recently, however, support for DWARF 2-style exception handling appeared in GCC/MinGW. Here, the Windows-“native” SEH is forgone for the same table-based exception handling scheme that is also used on Linux. The downside of this approach is obviously that it doesn’t integrate with SEH exceptions raised by the OS or other C libraries. But even if it is theoretically possible to catch those from D, this (DMD) feature isn’t really used widely, and as such virtually all D projects should be oblivious to the exception handling mechanism used under the hood.</p> <h2 id=status-overview>Status Overview</h2> <p>So, what can you expect from LDC on Win32/MinGW today? First, the good parts:</p> <ul> <li> <p><em>Exception handling</em> works, and all the related test cases that also pass on the various Posixen also pass on Win32/MinGW. Why this qualification? Just like GDC, LDC unfortunately doesn’t implement all the fine details of D’s exception chaining mechanism on any platform yet.</p> </li> <li> <p><em>Thread-local storage (TLS)</em> support is solid. Seeing this item on the list might surprise you, as TLS is central to each and every D2 application. However, it regularly turns out to be a pain point when porting D to new platforms, as it is typically not so important for other native languages. Thus, the related parts of the toolchains are typically less well tested, and LLVM on MinGW unfortunately was no exception here. At this point, however, my fixes to TLS support have arrived in the upstream versions of both mingw-w64 and LLVM, so no custom patches are required any longer (this is also the reason why LDC requires a very recent version of both).</p> </li> <li> <p>The <em>DMD, druntime and Phobos</em> test suites mostly pass, and some smaller applications I tested build and work just fine. This notably includes most functionality associated with 80-bit <code>real</code>s (aka <code>long double</code>), which is notoriously problematic as the Microsoft Visual C/C++ runtime (<em>MSVCRT</em>) does not support this type of floating point numbers at all.</p> </li> <li> <p>LDC is sufficiently ABI-compatible to DMD on 32-bit Windows that virtually all of the inline assembly code in druntime and Phobos works without changes. This only covers a surprisingly small part of the total ABI though, so even if DMD emitted COFF object files, it would still be a hopeless endeavor to try and link object files produced by the two compiles together, just as it is on the other operating systems.</p> </li> </ul> <p>Now, for the less pleasant points:</p> <ul> <li> <p>There are still a few issues related to floating-point math, particularly with complex 80-bit numbers. Single tests in <code>std.complex</code>, <code>std.math</code>, <code>std.mathspecial</code> and <code>std.internal.math.gammafunction</code>still fail, and <code>core.stdc.fenv</code> is not implemented properly yet. It seems to be likely that most of these problems are again caused by functions lacking from MSVCRT respectively their MinGW replacements (one specific example is <code>fmodl</code>, which seems to cause interesting ABI issues).</p> </li> <li> <p>The <code>core.sys.windows.dll</code> tests do not build, and while this would be easy to work around, DLL creation is entirely untested at this point.</p> </li> <li> <p>While MinGW theoretically supports COM, the <code>std.windows.iunknown</code> tests do not link yet because of missing symbols. There is likely an easy fix, but interfacing with COM has not been tested at all.</p> </li> <li> <p>There are also still two rather disconcerting test failures in <code>core.time</code> and <code>rt.util.container</code> which have not been tracked down yet.</p> </li> <li> <p>LDC currently relies on using the MinGW <code>as</code> for emitting object files, as the LLVM integrated assembler does not correctly support writing the DWARF exception handling tables yet. This is suboptimal, as it causes several issues with non-ASCII characters in symbol names and generally has a negative effect on compiler performance. It currently also causes an issue with building the <code>std.algorithm</code> unit tests in debug mode, where the humongous symbol names (in the tens of kilo(!)bytes) overflow some <code>as</code>-internal data structures.</p> </li> <li> <p>And most importantly, LDC/MinGW is still virtually untested on larger real-world applications. There will certainly be a number of bugs which have not been caught by any of the test suites.</p> </li> </ul> <h2 id=getting-started>Getting Started</h2> <p>So, how to try out LDC on Windows? The easiest thing would be to just download the latest binary (preview) release. For this, first grab a <em>very recent</em> mingw32-w64 snapshot, <a href="http://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win32/Personal%20Builds/rubenvb/gcc-4.8-dw2-release/i686-w64-mingw32-gcc-dw2-4.8.0-win32_rubenvb.7z/download">such as this one</a> (<em>rubenvb</em> personal build, <em>.7z</em>, ~27 MB) and extract it to an arbitrary location. It is important that you pick one built with Dwarf 2 exception handling enabled; when in doubt, just use the above one.</p> <p>Then, download and extract the latest <a href="http://d32gngvpvl2pi1.cloudfront.net/ldc2-0.11.0-beta3-mingw-x86.7z">LDC binary release for MinGW</a> (<em>.7z</em>, ~8.5 MB). It is a “DMD-style” package that should work from any location without any extra installation steps. Before invoking LDC, you need to make sure that the MinGW <code>bin</code> directory is on your path, though. This is easiest to achieve by starting a shell using <code>mingw32env.cmd</code> in the MinGW root directory, or of course using a MSYS shell altogether.</p> <p>If you prefer building LDC from source yourself, a guide on <a href="http://wiki.dlang.org/Building_LDC_on_MinGW_x86">building LDC on MinGW x86</a> is available on the wiki. Any help with LDC/MinGW development would be very much appreciated!</p> <footer> Like what you read? <a href="http://twitter.com/?status=@dnadlinger:">Let me know</a> what you think or <a href="http://twitter.com/?status=Just read »The State of LDC on Windows« by @dnadlinger: http://klickverbot.at/blog/2013/05/the-state-of-ldc-on-windows/">share the article</a> on Twitter. Also, there is more on <a href="/blog/tags/D/" title="View all posts tagged with »D«" rel=tag>D</a> and <a href="/blog/tags/LDC/" title="View all posts tagged with »LDC«" rel=tag>LDC</a>. </footer> </div> </article> </div> <footer id=main_footer> <ul> <li><a class=twitter href="//twitter.com/dnadlinger">Follow me on Twitter</a></li> <li><a class=mail href="/about">Contact me</a></li> <li><a class=rss href="/blog/atom.xml">Blog feed</a></li> </ul> </footer> </body> </html>