<!doctype html> <html lang=en> <head> <meta charset=utf-8> <link rel=stylesheet href='/css/250adbc.css'> <title>d4 | David Nadlinger</title> <meta name=viewport content="width=device-width; initial-scale=1.0"> <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script> <link rel="openid.server" href="http://openid.klickverbot.at/"/> <link rel="openid2.provider" href="http://openid.klickverbot.at/"/> </head> <body> <header id=main_header> <h1><span><a href="/">David Nadlinger</a></span></h1> <nav role=navigation> <ul> <li><a href="/blog">Blog</a></li> <li><a href="/code">Code</a></li> <li><a href="/about">About</a></li> </ul> </nav> </header> <div role=main id=main_content> <div class=article> <header> <ul class=catnav> <li><a href="/code">Code</a></li> <li><a href="/code/gsoc/thrift">GSoC 2011</a></li> </ul> </header> <div class=content><h1>d4</h1> <h2 id=introduction>Introduction</h2> <p>d4 is a simple <a href="http://en.wikipedia.org/wiki/Software_rendering">software rasterizer</a> written in the <a href="http://digitalmars.com/d/1.0">D programming language</a>. It was originally a part of my <i>Matura</i> exam (comparable to the British A levels) in mathematics, along with a scholarly paper on the mathematical basics of realtime 3D rendering – you can find <a href="/science/3d-mathematics/">the paper</a> here as well, but it probably won&#8217;t be of much use unless you understand German.</p> <p>One of my design goals was to stick fairly close to the architecture of the 3D pipeline of DirectX/OpenGL so that actual code could be used to illustrate some parts of the paper. I ended up not including any code in the text, but the design remained the same. As a consequence, for instance the semantics of the vertex and pixel shaders are very similar to the »real« ones.</p> <p>Another requirement was that even people who had little to no experience with 3D programming should be able to make sense of the code. Thus, the sources are documented fairly well, and, more important, I did <em>not sacrifice much readability for performance</em>.</p> <p>Working on the code has turned out to be quite fun, and so I created a few small demo applications, two of which are included in the repository. While I was writing the code for them, I almost felt like if I had been a thin engine layer above DirectX (minus its semi-OO design, naturally, which I am not too fond of). Mission accomplished.</p> <h2 id=features>Features</h2> <p>As mentioned above, the architecture of d4&#8217;s 3D pipeline resembles the ones found on modern graphics cards. This also means that the set of supported features is quite similar, at least from a high-level point of view. For example, the renderer supports <em>perspectively correct interpolation, backface culling, z-buffering, vertex and pixel shaders, texturing,</em> and so on. The project also includes a tiny <a href="http://www.libsdl.org"><abbr><span class=caps>SDL</span></abbr></a> based application »framework« to make playing around with the rasterizer easier.</p> <p>Please note, however, that d4 is still about demonstrating the <em>basics</em> of realtime rasterization and not about replicating a <abbr><span class=caps>GPU</span></abbr> in software. Therefore, you can also find quite a number of features on recent graphics cards which d4 does not support: geometry shaders, instancing, multiple render targets, <abbr><span class=caps>HDR</span></abbr> rendering and mip mapping (and thus trilinear/anisotropic filtering), to name a few.</p> <p>Most of the above would be easy to implement, but there is another obvious problem which would render these more advacnced features virtually useless: Performance. It is widely known that even the fastest, most optimized software renderers are embarassingly slow when compared to today&#8217;s graphics cards. Additionally, as I stated in the introduction, my primary goals were readability and clean design, not maximum performance. No hand-crafted <abbr title="Single Instruction, Multiple Data; e.g. SSE"><span class=caps>SIMD</span></abbr> assembler (well, no inline assembler at all), no fixed-point math, no fancy programming tricks, and no optimization specifically for a single application – which inevitably means: bad performance.</p> <p>However, I still wanted my simple demo applications to run at an acceptable speed, so wasting lots of compution time was not what I intended either. Apart from general precautions (like avoiding allocations and GC activity), I also used parts of the extensive metaprogramming facilities of D to create a shader system based on templates. The big advantage of this is that it enables the compiler to inline the shader into the rasterization loop, but remains straightforward in use. After discovering the <abbr><span class=caps>LLVM</span></abbr>-based <a href="http://dsource.org/projects/ldc"><abbr><span class=caps>LDC</span></abbr></a> which offers much more sophisticated optimizations than the standard Digital Mars compiler, I decided that I won&#8217;t do any big optimizations manually because the performance is already acceptable.</p> <p>There are also some downsides to my approach, though: Firstly, templates are evaluated at compile-time, so runtime modifications are not possible (at least not without sacrifying performance). For future versions, I plan to implement dynamic shader (re-)compilation to work around this. Secondly, relying on the compiler to optimize speed-critical code obviously causes the quality of its optimizer to greatly influence the performance. For example, binaries produced by <abbr><span class=caps>LDC</span></abbr> are typically several times faster than the ones <abbr><span class=caps>DMD</span></abbr> generates. Unfortunately, <abbr><span class=caps>LDC</span></abbr> is not of production quality on Windows yet; most notable it lacks support for exceptions.</p> <h3>File formats</h3> <p>The Open Asset Import Libary (<a href="http://assimp.sf.net">Assimp</a>) is used for reading model files. Thanks to this excellent library, d4 can read over twenty different model file formats:</p> <ul class="columns2 bullet"> <li>Collada (*.dae)</li> <li>3D Studio Max 3DS (*.3ds)</li> <li>3D Studio Max <span class=caps>ASE</span> (*.ase)</li> <li>Wavefront Object (*.obj)</li> <li>Stanford Polygon Library (*.ply)</li> <li>AutoCAD <span class=caps>DXF</span> (*.dxf)</li> <li>LightWave (*.lwo)</li> <li>Stereolithography (*.stl)</li> <li>AC3D (*.ac)</li> <li>Valve Model (*.smd, *.vta)</li> <li>Quake I (*.mdl)</li> <li>Quake II (*.md2)</li> <li>Quake <span class=caps>III</span> (*.md3)</li> <li>Return to Castle Wolfenstein (*.mdc)</li> <li>Doom 3 (*.md5)</li> <li>Biovision <span class=caps>BVH</span> (*.bvh)</li> <li>DirectX X (*.x)</li> <li>Quick3D (*.q3d)</li> <li>Irrlicht Mesh (*.irrmesh)</li> <li>Neutral File Format (*.nff)</li> <li>Sense8 WorldToolKit (*.nff)</li> <li>Object File Format (*.off)</li> <li>PovRAY Raw (*.raw)</li> <li>Terragen Terrain (*.ter)</li> <li>3D GameStudio (*.mdl)</li> <li>3D GameStudio Terrain (*.hmp)</li> </ul> <p>Another jewel of a library is <a href="http://openil.sourceforge.net">DevIL</a>, which is used to read texture data. Thanks to it, this program can cope with 30 different pixel image formats:</p> <ul class=columns6> <li>*.act</li> <li>*.bmp</li> <li>*.cut</li> <li>*.dcx</li> <li>*.dds</li> <li>Doom</li> <li>*.exr</li> <li>*.gif</li> <li>*.hdr</li> <li>*.ico</li> <li>*.icns</li> <li>*.jpg</li> <li>*.jp2</li> <li>*.lbm</li> <li>*.lif</li> <li>*.mdl</li> <li>*.pal</li> <li>*.pcd</li> <li>*.pcx</li> <li>*.pic</li> <li>*.png</li> <li>*.pnm</li> <li>*.psd</li> <li>*.psp</li> <li>*.raw</li> <li>*.sgi</li> <li>*.tga</li> <li>*.tif</li> <li>*.vtf</li> <li>*.wal</li> </ul> <h2 id=demos>Demos</h2> <p>d4 currently includes two small applications demonstrating the features of the rasterizer: <em>Viewer</em>, a minimal model viewer which loads a model from disk and displays it on sceen using the textures or vertex colors from the file (if any), and <em>SpinningLights</em>, which demonstrates more complex per-pixel lighting by illuminating the scene with two colored omni lights (point lights) rotating around the y-axis.</p> <p>Both programs accept several options at the command line, pass the <code>--help</code> option for an overview. Keyboard commands:</p> <ul class=bullet> <li><i>W, S, A, D</i>: Move the camera.</li> <li>Cursor keys: Rotate the camera.</li> <li><i>U, I</i>: Move the lights in and out, holding <i>Alt</i> changes the direction. <span class="_SpinningLights only_">(<em>SpinningLights only</em>)</span></li> <li><i>Shift</i>: Move/rotate faster.</li> <li><i>Y, Z</i>: Toggle materials and Gouraud shading. <span class="_Viewer only_">(<em>Viewer only</em>)</span></li> <li><i>X</i>: Toggle wireframe mode.</li> <li><i>C</i>: Toggle backface culling.</li> <li><i>V</i>: Toggle auto world rotation. <span class="_Viewer only_">(<em>Viewer only</em>)</span></li> <li><i>B</i>: Use a colorful animated background. <span class="_Viewer only_">(<em>Viewer only</em>)</span></li> </ul> <h2 id=download>Download</h2> <p>The downloads below contain the source tree of the d4 release 0.1. To start playing around, you need a working, not-too-old D1 compiler configured for use with <a href="http://dsource.org/projects/tango/">Tango</a> (if in doubt, just try the packages from the Tango website), a build tool and the <a href="http://dsource.org/projects/derelict/">DerelictIL/<span class=caps>SDL</span></a> and <a href="http://assimp.svn.sourceforge.net/viewvc/assimp/trunk/port/dAssimp/">dAssimp</a> bindings (either in your system-wide inclue path or in the <a href="http://github.com/dnadlinger/d4/blob/v0.1/libs/README">libs/ directory</a>). A configuration file for <a href="http://dsource.org/projects/dsss"><abbr><span class=caps>DSSS</span></abbr></a> is included, although I personally use <a href="http://bitbucket.org/h2r3tic/xfbuild/wiki/Home">xfBuild</a> now.</p> <ul class=columns2> <li><a href="http://github.com/dnadlinger/d4/tarball/v0.1" class="icon tar">d4 0.1, sources, Gzip&#8217;d tarball</a></li> <li><a href="http://github.com/dnadlinger/d4/zipball/v0.1" class="icon zip">d4 0.1, sources, Zip archive</a></li> </ul> <p>If you do not have a D1/Tango environment available and just want to see what the rasterizer produces, you can also download one of the pre-built versions:</p> <ul class=columns2> <li><a href="http://github.com/downloads/klickverbot/d4/d4-0.1-linux-x86_32.tar.gz" class="icon tar">d4 0.1 binaries, Linux 32 bit</a></li> <li><a href="http://github.com/downloads/klickverbot/d4/d4-0.1-windows-x86_32.zip" class="icon zip">d4 0.1 binaries, Windows 32 bit</a></li> </ul> <p>The Windows package contains two binaries, one built with <abbr><span class=caps>DMD</span></abbr> and another one built with <abbr><span class=caps>LDC</span></abbr>. The <abbr><span class=caps>LDC</span></abbr> one runs significantely faster, but when any error occurs, it aborts with an interal error instead of displaying a useful message (see above). The package also contains a recent version of all the needed DLLs, it should work out of the box.</p> <p>The linux version, however, only has a copy of the not-yet-released Assimp along with the binary. If the widely-used DevIL and <abbr><span class=caps>SDL</span></abbr> libraries are not yet present on your system, you have to install them via your package manager of choice first.</p> <p>The packages also include a free model of a dwarf by an artist named <a href="http://www.psionic3d.co.uk">Psionic</a> so that you can play around with d4 in case you don&#8217;t have another one handy.</p> <h2 id=hacking>Hacking</h2> <p>The full source tree of this project, representing the latest state of development, is available at <a href="http://github.com/dnadlinger/d4/">GitHub</a>. You are absolutely encouraged to fork the project and start hacking right away.</p> <p>If you want to tell me about any bugs or have sugestions for improvement, please <a href="http://github.com/dnadlinger/d4/issues">file an issue</a> or contact me via email (see <a href="/about#contact">About</a>).</p> <h2 id=license>License</h2> <p>d4 is free Open Source software and is distributed under the <abbr><span class=caps>GNU</span> <span class=caps>GPL</span> 3</abbr> (or any later version). However, please do not hesitate to contact me if you want to use parts of it under a more permissive license.</p> <p>The <abbr><span class=caps>BSD</span></abbr>-licensed Assimp library is © <span class=caps>ASSIMP</span> Development Team; DevIL and the multimedia library <abbr><span class=caps>SDL</span></abbr> are used under the terms of the <abbr><span class=caps>GNU</span> <span class=caps>LGPL</span></abbr>.</p></div> </div> </div> <footer id=main_footer> <ul> <li><a class=twitter href="//twitter.com/dnadlinger">Follow me on Twitter</a></li> <li><a class=mail href="/about">Contact me</a></li> <li><a class=rss href="/blog/atom.xml">Blog feed</a></li> </ul> </footer> </body> </html>